<%#= form_tag root_path, method: :get do %>
  <%#= select_tag :time_type,
    options_for_select(%w(days weeks months years), params[:time_type]),
    # selected: params[:time_type],
    {class: "form-control"}%>
  <%#= text_field_tag :time_ago,
    params[:time_ago],
    class: "form-control",
    placeholder: "whitout restriction"%>
  <%#= text_field_tag :top_count,
    params[:top_count],
    class: "form-control",
    value: OrderItem::DEFAULT_TOP_NUMBER%>
    <%#= submit_tag "apply" %>
<%# end %>
<% time_type =  (params[:time_type] || "months").to_s%>
<% time_ago =  (params[:time_ago] || 3).to_i%>
<% top_number = (params[:top_count] || OrderItem::DEFAULT_TOP_NUMBER).to_i %>
<% revenue_for_top_number = 0 %>

<% if params[:time_ago] %>
  <% best_sellers_list =  Order.joins(:order_items).where(purchase_date: time_ago.send(time_type).ago..Date.today).top(:product_id, top_number)%>
<% else %>
  <% best_sellers_list =  Order.joins(:order_items).top(:product_id, top_number)%>
  <% best_sellers =  OrderItem.joins(:product).top(:title, 5) %>
<% end %>
<% best_sellers_list.each do|product| %>
  <% orders = OrderItem.where("product_id = #{product[0]}") %>
  <% revenue_for_top_number += orders.sum("item_price_cents *quantity")%>
<% end %>

<div class="text-center">
  <h3>
    <%= render partial: "shared/animated_number", locals: { value: revenue_for_top_number / 100, format: 'JPY', spanclass: 'highlight' } %>
  </h3>
  <p>revenue generated by the top <%= top_number %> SKU</p>
</div>

<%= pie_chart best_sellers,
  library: {
    legend: {
      labels: {
        fontColor: '#FFFFFFCC',
      },
      position: 'bottom'
    },
    gridLines: {
      color: '#FFFFFFCC'
    }
  } %>
